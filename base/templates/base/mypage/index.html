{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/mypage.css' %}">
{% endblock %}

{% block main %}
<div class="container mypage-container">
  <h2>マイページ</h2>

  <section class="mypage-section">
    <h3>ユーザー名</h3>
    <p>{{ user.username }}</p>
    <a href="{% url 'username_update' %}" class="btn-primary">編集する</a>
  </section>

  <section class="mypage-section">
    <h3>メール</h3>
    <p>{{ user.email }}</p>
    <a href="{% url 'account_email' %}" class="btn-primary">編集する</a>
  </section>

  <section class="mypage-section">
    <h3>予約一覧</h3>

    {% if my_reservations %}
      <ul class="reservation-list">
        {% for r in my_reservations %}
          <li class="reservation-item">
            <a href="{% url 'restaurant_detail' pk=r.restaurant.pk %}">
              {{ r.restaurant.name }}
            </a>
            <span class="reservation-meta">
              （{{ r.date|date:"Y/m/d" }} {{ r.time|time:"H:i" }} /
              {{ r.number_of_people }}名）
            </span>

            <div class="reservation-actions">
              <a href="{% url 'restaurant_reservation_cancel' pk=r.pk %}"
                 class="btn-danger">
                予約をキャンセルする
              </a>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>現在、予約はありません。</p>
    {% endif %}
  </section>

  <section class="mypage-section">
    <h3>お気に入り</h3>

    {% if favorite_restaurants %}
    <ul>
      {% for fav in favorite_restaurants %}
      <li>
        <a href="{% url 'restaurant_detail' fav.restaurant.pk %}">
          {{ fav.restaurant.name }}
        </a>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>お気に入りはまだありません。</p>
    {% endif %}
  </section>

  <section class="mypage-section">
    <h3>サブスクリプション</h3>

    {% if user.subscription.is_active %}
    <p>現在サブスクリプションに登録しています。</p>
    <p>有効期間: {{ user.subscription.started_at|date:"Y/m/d" }} - {{ user.subscription.ended_at|date:"Y/m/d" }}</p>
    <a href="{% url 'subscription_cancel' %}" class="btn-danger">解約する</a>
    {% else %}
    <p>サブスクリプションに登録していません。</p>
    <a href="{% url 'subscription_create' %}" class="btn-primary">登録する</a>
    {% endif %}
  </section>

  <section class="card-section">
    <h3>カード情報</h3>

    {% if user.billing and user.billing.default_payment_method_id %}
    <p>カード情報が登録されています。</p>
    <a href="{% url 'card_info' %}" class="btn-primary">カード情報を確認する</a>
    {% else %}
    <p>カード情報が登録されていません。</p>
    <a href="{% url 'card_update' %}" class="btn-primary">カード情報を登録する</a>
    {% endif %}
  </section>

  <section class="mypage-section">
    <h3>あなたのレビュー</h3>

    {% if my_reviews %}
    <ul class="review-list">
      {% for review in my_reviews %}
      <li class="review-item">
        <a href="{% url 'restaurant_detail' pk=review.restaurant.pk %}">
          {{ review.restaurant.name }}
        </a>
        <span>({{ review.rating }} / 5)</span>
        {% if review.comment %}
        <p>{{ review.comment|linebreaksbr }}</p>
        {% endif %}

        <div class="review-actions">
          <a href="{% url 'restaurant_review_update' review_pk=review.pk %}" class="btn-secondary">
            編集
          </a>
          <a href="{% url 'restaurant_review_delete' review_pk=review.pk %}" class="btn-danger">
            削除
          </a>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>まだレビューを書いていません。</p>
    {% endif %}
  </section>

</div>
{% endblock %}